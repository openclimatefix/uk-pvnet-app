name: Conda pytest
on: 
  push:
  pull_request:
    types: [opened, reopened]

jobs:
  test-unit:
    runs-on: ubuntu-latest
    container: quay.io/condaforge/miniforge3:latest

    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"
          python-version: '3.12' 
      
      - name: Install ESMF and GDAL
        run: conda create --quiet --yes -p .venv python=3.12 esmpy gdal

      - name: Install editable package and required dependencies
        run: uv sync --inexact

      - name: Run unit tests (with pytest)
        env:
          SATELLITE_ZARR_PATH: "latest.zarr.zip"
          NWP_UKV_ZARR_PATH: "temp_nwp_ukv.zarr"
        run: uv run python -m pytest --junitxml=ut-report.xml

      # Create test summary to be visualised on the job summary screen on GitHub
      # * Runs even if previous steps fail
      - name: Create test summary
        uses: test-summary/action@v2
        with:
          paths: "*t-report.xml"
          show: "fail, skip"
        if: always()

